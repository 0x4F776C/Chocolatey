# Install Chocolatey
Set-ExecutionPolicy Bypass -Scope Process -Force
[System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))

# Disable Windows Defender
cmd.exe /c 'sc.exe WinDefend start= disabled'
cmd.exe /c 'sc.exe stop WinDefend'

# Install CAPEv2 depedencies and analysis tools
choco install microsoft-office-deployment /PersonalRetail -y
choco install python3 --version=3.6.2 -y
choco install googlechrome -y
choco install javaruntime -y
choco install dotnetfx -y
choco install dotnet4.7.2 -y
choco install vcredist-all -y
choco install wixtoolset -y
choco install msxml4.sp3 -y
choco install msxml6.sp1 -y

pip install pillow pywintrace

choco install adobereader2017 -s \\192.168.100.1\Public\package\adobereader2017\

# Install PolarProxy MiTM certificate
cmd.exe /c 'certutil -addstore -f "root" "\\192.168.100.1\Public\transfer\PolarProxy.cer"'

# Transfer Sysmon and Procmon
Copy-Item -Recurse \\192.168.100.1\Public\transfer\Sysmon C:\
Copy-Item -Recurse \\192.168.100.1\Public\transfer\ProcessMonitor C:\

# Transfer CAPEv2 agent.py
Copy-Item -Recurse \\192.168.100.1\Public\transfer\agent.py C:\

# Start Sysmon
cmd.exe /c 'C:\Sysmon\Sysmon.exe -accepteula -i \\192.168.100.1\Public\transfer\sysmon-config\sysmonconfig-export.xml'
#cmd.exe /c 'C:\ProcessMonitor\Procmon.exe -accepteula /backingfile C:\procmon.pml /quiet

# Download win7noise removal script and execute it
cmd.exe /c 'certutil.exe -urlcache -f "https://github.com/0x4F776C/Setup-Guides/blob/main/Chocolatey/files/disable_win7noise.bat" disable_win7noise.bat'
cmd.exe /c 'disable_win7noise.bat'

# Restart system
cmd.exe /c 'shutdown -r -t 0'
